# 字节码篇

## 什么是字节码指令(byte code)？

Java虚拟机的指令由一个字节长度的、代表着某种特定操作含义的==操作码== (opcode)以及跟随其后的零至多个代表此操作所需参数的==操作数== (operand)所构成。虚拟机中许多指令并不包含操作数，只有一个操作码。

## 文件结构有几个部分？

Class文件的总体结构如下：

- 魔数
- Class文件版本
- 常量池
- 访问标识（或标志）
- 类索引，父类索引，接口索引集合
- 字段表集合
- 方法表集合
- 属性表集合

## Class文件的魔数是什么？

class文件的标识

- 每个Class文件开头的4个字节的无符号整数称为魔数（magic Number)。
- 它的唯一作用是确定这个文件是否为一个能被虚拟机接受的有效合法的Class文件，即：魔数是Class文件的标识符。
- 魔数值固定为0xCAFEBABE，不会改变。
- 如果Class文件不以0xCAFEBABE开头，虚拟机在进行文件校验的时候就会直接抛出错误。
- 使用魔数而不是扩展名来进行识别主要是基于安全方面的考虑，因为文件扩展名可以随意改动。

## 如何确保高版本的JVM可执行低版本的class文件？

- 版本号和Java编译器的对应关系如下表：

| 主版本（十进制） | 副版本（十进制） | 编译器版本 |
| -------- | -------- | ----- |
| 45       | 3        | 1.1   |
| 46       | 0        | 1.2   |
| 47       | 0        | 1.3   |
| 48       | 0        | 1.4   |
| 49       | 0        | 1.5   |
| 50       | 0        | 1.6   |
| 51       | 0        | 1.7   |
| 52       | 0        | 1.8   |
| 53       | 0        | 1.9   |
| 54       | 0        | 1.10  |
| 55       | 0        | 1.11  |

- Java的版本号是从45开始的，JDK1.1以后的每个JDK大版本发布主版本号向下兼容

## 常量池：class文件的基石？作用是？

### 为什么需要常量池计数器？

constant_pool_count（常量池计数器）

- 由于常量池的数量不固定，时长时短，所以需要放置两个字节来表示常量池计数值。
- 常量池容量计数值（u2类型）：从1开始，表示常量池中有多少项常量。即constant_pool_count=1表示常量池中有0个常量项。

### 常量池表

- constant_pool是一种表结构，以1~constant_pool_count-1为索引。表明了后面有多少个常数项。
- 常量池主要存放两大类常量：==字面量（Literal）== 和==符号引用（Symbolic Reference）== 
- 它包含了class文件结构及其子结构中引用的所有字符串常量、类或接口名、字段名和其他常量。常量池中每一项都具备相同的特征。第1个字节作为类型标记，用于确定该项的格式，这个字节称为tag byte（标记字节、标签字节）

#### 字面量和符号引用

| 常量   | 具体的常量        |
| ---- | ------------ |
| 字面量  | 文本字符串        |
|      | 声明为final的常量值 |
| 符号引用 | 类和接口的全限定名    |
|      | 指定的名称和描述符    |
|      | 方法的名称和描述符    |

#### 谈谈你对符号引用、直接引用的理解？

Java代码在进行编译Javac编译的时候，并不像C和C++那样有“连接”这一步骤，而不是虚拟机加载Class文件的时候进行动态链接。也就是说，==虚拟机在Class文件中不会保存各个方法、字段的最终内存布局信息，因此这些字段、方法的符号引用不经过运行期转换的话无法得到真正的内存入口地址，也就无法直接被虚拟机使用。 当虚拟机运行时，需要从常量池获得对应的符号引用，再在类创建或运行时被解析、编译到具体的内存地址之中。== 

符号引用和直接引用的区别与关联：

- 符号引用：符号引用以==一组符号== 来描述引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可。==符号引用与虚拟机实现的内存布局无关== ，引用的目标并不一定已经加载到内存中。
- 直接引用：直接引用可以是直接==指向目标的指针、相关偏移量或一个能间接定位到目标的句柄。直接引用是与虚拟机实现的内存布局相关的== ，同一个符号引用在不同虚拟机实例上翻译出来的直接引用一般不会相同。如果有了直接引用，那说明引用的目标必定已经存在于内存之中了。

## 访问标识

- 在常量池后



